# 中断子系统

HANAOS 实现了通用的中断子系统，并针对两种架构下的中断控制方式进行了驱动的适配。对于 RISCV，子系统调用 PLIC 控制器驱动来控制中断；对于龙芯来说，其具有更复杂的中断路由，子系统支持使用 pch-pic 控制器的传统中断和使用 pch-msi 控制器的 msi 中断，二者都通过 eiointc 被通用子系统使用。下面针对具体几方面进行论述。

## 通用中断注册、响应和堆栈

通用中断子系统包含了中断子系统初始化、中断响应等功能，提供给驱动使用的接口有中断注册和中断堆栈。通用的子系统规定了架构子系统应该提供的接口的原型，实现了架构无关。

对于中断注册，驱动需要提供原型与`typedef irqret_t (*irq_handler_t)(uint32, void*);`一致的中断处理函数、中断号和中断私有数据，`irq_register`函数会将这些数据保存并且调用架构中断接口`__irq_enable_default`，开启该中断号的使能。

对于中断相应，子系统在 trap 中注册了响应函数`void irq_response(void);`，通过匹配 trap 的来源该函数被调用，此时该函数会调用`__irq_get`从架构中断系统中获取中断号，调用保存的对应中断处理函数。完成后，调用`__irq_put`完成中断处理。

中断子系统还提供了保存或读取先前中断开关状态并开关中断的接口`irq_pushoff`和`irq_popoff`，模块或者驱动可以成对的时候开关闭中断但不影响调用栈中的其他函数的中断状态。

## RISCV 中断子系统

RISCV 使用 PLIC 作为中断子系统的外部中断控制器。HANAOS 中，我们在 S-MODE 下管理中断。

中断控制器 PLIC 的初始化只进行一个操作，即将 S-MODE 下的中断 threshold 设为 0，这样设为非零的 priority 值的中断都能被允许使用。

PLIC 对于中断的使能和禁用是通过写两个寄存器来实现的。首先是将 S-MODE 下的中断使能寄存器对应比特设为 0 或 1；其次为设定 S-MODE 下的中断优先级，根据实现设定的 threshold，priority 设为 0 即为屏蔽中断，设为 1 即可解除中断。注意这两个操作都是对指定 CPU 核心进行配置的。

PLIC 通过读 S-MODE 下的 claim 寄存器来获取当前要处理的中断号，对这个寄存器写入已经处理的中断号即可清除中断请求位。

## Loongarch 中断子系统

龙芯的中断子系统比较复杂，主要分为处理器中的 eiointc 控制器和桥片中的 pic、msi 控制器。qemu 中，龙芯的外部中断遵循虚拟扩展IRQ模型，如下图：

```
+-----+    +-------------------+     +-------+
| IPI |--> | CPUINTC(0-255vcpu)| <-- | Timer |
+-----+    +-------------------+     +-------+
                     ^
                     |
               +-----------+
               | V-EIOINTC |
               +-----------+
                ^         ^
                |         |
         +---------+ +---------+
         | PCH-PIC | | PCH-MSI |
         +---------+ +---------+
           ^      ^          ^
           |      |          |
    +--------+ +---------+ +---------+
    | UARTs  | | Devices | | Devices |
    +--------+ +---------+ +---------+
```

包含串口中断在内的传统中断都通过 PCH-PIC 控制器路由并发往 eiointc 控制器，PCI 设备产生的 MSI-X 中断通过 PCH-MSI 控制器发往 eiointc 控制器。

### PCH-PIC 控制器

PCH-PIC 控制器是 loongson 7a1000 桥片的中断控制器，下面简称 pic 控制器。

pic 控制器的初始化仅有一个操作，即设置中断电平触发极性选择寄存器为高电平触发，这是默认的外设触发方式。

pic 控制器对于中断的使能分为三个步骤。一、写HT消息包中断使能寄存器，启用HT消息中断；二、写中断屏蔽寄存器，解除对应中断的屏蔽；三、配置HT中断向量路由，将引脚中断号配置到相同的路由中断号，方便编程。中断的禁用和使能步骤和操作相反，但不用消除中断路由。

值得注意的是，7A1000 手册 5.3 节中提到，除了 AC97DMA 中断和 gpio 中断外，其余中断都必须配置为电平中断、高电平有效，故中断的使能中不需要配置边沿方式，中断结束不需要进行任何操作。

### PCH-MSI 控制器

PCH-MSI 控制器在 PCI 设备的 MSI-X 中断中使用，详见 PCI 驱动的 MSI-X 部分。PCH-MSI 控制器只有一个 64 位寄存器，设备发出 msi 中断时，寄存器填入中断向量的值。从设备树中可以知道，这个控制器的中断向量号范围是从 0x20 开始的 0xe0 个整数。

### eiointc 控制器

eiointc 控制器用于龙芯 3A5000 开始支持的扩展 I/O 中断，是 qemu 默认的中断控制器。eiointc 接收上述两个桥片控制器的中断路由并路由给相应的 CPU 核心。

eiointc 控制器的初始化有两个操作。首先，设置所有范围的中断引脚中断路由引脚号，为了方便设为 0；然后设置节点 node0 的映射向量，设置中断指在节点 0 上进行分发。

eiointc 控制器对于中断的使能分为两个步骤，首先写 EXT_IOIen 寄存器，配置中断号的中断使能；然后设置中断的处理器核路由方式，让中断只分发给默认的核心。中断的禁用和使能步骤和操作相反。

eiointc 控制器通过读指定核心的 EXT_IOIsr 寄存器，按位获得哪些中断是当前设备发出的，每次返回中断号最小的待相应中断给中断子系统。相应完成之后，将 EXT_IOIsr 寄存器的对应位写 1 来消除中断。